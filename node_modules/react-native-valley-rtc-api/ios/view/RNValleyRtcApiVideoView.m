#import "RNValleyRtcApiVideoView.h"
#import "../RNValleyRtcApiInternal.h"

#import <React/RCTLog.h>
#import <React/UIView+React.h>

@implementation RNValleyRtcApiVideoView

- (instancetype)init {
    self = [super init];
    if (self) {
        self.index = -1;
        self.remove = true;
        self.local = true;
        self.reload = false;
        self.userId = nil;
    }
    return self;
}

- (void)didUpdateReactSubviews
{
//  // RNValleyVideoView expects that the first subview rendered is the mask.
//  UIView *maskView = [self.reactSubviews firstObject];
//  self.maskView = maskView;
//
//  // Add the other subviews to the view hierarchy
//  for (NSUInteger i = 1; i < self.reactSubviews.count; i++) {
//    UIView *subview = [self.reactSubviews objectAtIndex:i];
//    [self addSubview:subview];
//  }
}

- (void)displayLayer:(CALayer *)layer
{
  // RCTView uses displayLayer to do border rendering.
  // We don't need to do that in RCTMaskedView, so we
  // stub this method and override the default implementation.
}

- (void)setIndex:(NSInteger)index {
    _index = index;
}

- (void)setRemove:(BOOL)remove {
    _remove = remove;
}

- (void)setLocal:(BOOL)local {
    _local = local;
}

- (void)setUserId:(NSString *)userId {
    _userId = userId;
}

- (void)setReload:(BOOL)reload {
    _reload = reload;
    RCTLogInfo(@"=======  setReload, reload = %d, index = %ld, remove = %d, local = %d, userid = %@", _reload ,(long)_index, _remove, _local, _userId);
    if (_reload) {
        if (_index != -1) {
            if (_remove) {
                if (_local) {
                    [[RNValleyRtcApiInternal GetInstance] RemoveLocalVideo:_index];
                }
                else {
                    if (_userId != nil && ![_userId isEqual: @""]) {
                        [[RNValleyRtcApiInternal GetInstance] RemoveUserVideo:_index userid:_userId];
                    }
                }
            }
            else {
                xVideoCanvas *canvas = [xVideoCanvas new];
                canvas.view = self;
                if (_local) {
                    [[RNValleyRtcApiInternal GetInstance] SetLocalVideo:_index hVideo:canvas];
                }
                else {
                    if (_userId != nil && ![_userId isEqual: @""]) {
                        [[RNValleyRtcApiInternal GetInstance] SetUserVideo:_index userid:_userId hVideo:canvas];
                    }
                }
            }
        }
    }
}

@end
